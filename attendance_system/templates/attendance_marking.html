{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-3">
        <div class="col">
            <h1 class="h3 mb-0">
                <i class="fas fa-camera"></i> Attendance Marking
            </h1>
        </div>
        <div class="col-auto">
            <button class="btn btn-outline-danger" onclick="handleLogout()">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>
    </div>
    <div class="row">
        <!-- Webcam Section -->
        <div class="col-lg-8">
            <div class="card shadow-lg border-0">
                <div class="card-header bg-gradient-danger text-white p-4">
                    <h2 class="mb-0"><i class="fas fa-face-smile-wink me-2"></i>Attendance Marking</h2>
                    <p class="text-light mb-0 mt-2">Real-time face recognition attendance</p>
                </div>
                <div class="card-body p-4">
                    <!-- Session Selection -->
                    <div class="mb-4">
                        <label for="sessionSelect" class="form-label fw-bold">
                            <i class="fas fa-calendar-check"></i> Select Session
                        </label>
                        <select id="sessionSelect" class="form-select" onchange="loadSessionDetails()">
                            <option value="">-- Load available sessions --</option>
                        </select>
                    </div>

                    <!-- Webcam Container -->
                    <div class="position-relative mb-4 rounded-3 overflow-hidden" style="height: 500px; background: #000;">
                        <video id="attendanceWebcam" width="100%" height="100%" style="object-fit: cover; transform: scaleX(-1);"></video>
                        <canvas id="attendanceCanvas" style="display: none;"></canvas>
                        
                        <!-- Face Detection Overlay -->
                        <div id="faceOverlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"></div>

                        <!-- Webcam Status Badge -->
                        <div class="position-absolute top-3 end-3">
                            <span id="webcamStatus" class="badge bg-danger">
                                <i class="fas fa-video"></i> Initializing
                            </span>
                        </div>

                        <!-- Detected Face Info -->
                        <div id="faceInfo" class="position-absolute bottom-3 start-3 bg-dark bg-opacity-75 text-white p-3 rounded" style="display: none; max-width: 300px;">
                            <div id="faceInfoContent"></div>
                        </div>
                    </div>

                    <!-- Webcam Controls -->
                    <div class="d-flex gap-2 mb-4">
                        <button id="startAttendanceWebcamBtn" class="btn btn-primary" onclick="startAttendanceWebcam()">
                            <i class="fas fa-play"></i> Start Webcam
                        </button>
                        <button id="stopAttendanceWebcamBtn" class="btn btn-danger" style="display: none;" onclick="stopAttendanceWebcam()">
                            <i class="fas fa-stop"></i> Stop Webcam
                        </button>
                        <button id="captureAttendanceBtn" class="btn btn-success" style="display: none;" onclick="captureAttendance()">
                            <i class="fas fa-camera"></i> Mark Attendance
                        </button>
                    </div>

                    <!-- Recognition Status -->
                    <div id="recognitionStatus" class="alert alert-info" style="display: none;">
                        <i class="fas fa-spinner fa-spin"></i> Recognizing face...
                    </div>
                </div>
            </div>
        </div>

        <!-- Attendance Status Panel -->
        <div class="col-lg-4">
            <div class="card shadow-lg border-0 mb-4">
                <div class="card-header bg-gradient-info text-white p-4">
                    <h5 class="mb-0"><i class="fas fa-info-circle"></i> Session Details</h5>
                </div>
                <div class="card-body p-4">
                    <div id="sessionDetailsContainer">
                        <p class="text-muted">Select a session to view details</p>
                    </div>
                </div>
            </div>

            <div class="card shadow-lg border-0">
                <div class="card-header bg-gradient-success text-white p-4">
                    <h5 class="mb-0"><i class="fas fa-history"></i> Recent Attendance</h5>
                </div>
                <div class="card-body p-0" style="max-height: 400px; overflow-y: auto;">
                    <div id="recentAttendanceContainer" class="p-3">
                        <p class="text-muted">No recent records</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Manual Attendance Section -->
    <div class="row mt-5">
        <div class="col-lg-12">
            <div class="card shadow-lg border-0">
                <div class="card-header bg-gradient-warning text-white p-4">
                    <h5 class="mb-0"><i class="fas fa-pencil-alt"></i> Manual Attendance Entry</h5>
                </div>
                <div class="card-body p-4">
                    <form id="manualAttendanceForm">
                        <div class="row">
                            <div class="col-md-3">
                                <label for="manualStudent" class="form-label">Student</label>
                                <select id="manualStudent" class="form-select" required>
                                    <option value="">-- Select Student --</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="manualStatus" class="form-label">Status</label>
                                <select id="manualStatus" class="form-select" required>
                                    <option value="present">Present</option>
                                    <option value="absent">Absent</option>
                                    <option value="late">Late</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="manualDate" class="form-label">Date</label>
                                <input type="date" id="manualDate" class="form-control" required>
                            </div>
                            <div class="col-md-3 d-flex align-items-end">
                                <button type="submit" class="btn btn-warning w-100">
                                    <i class="fas fa-plus"></i> Add Entry
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Messages Container -->
    <div id="attendanceMessages" class="mt-4"></div>
</div>

<!-- Face detection library -->
<script async src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.min.js"></script>
<script src="{% static 'js/attendance-marking.js' %}"></script>

<style>
    .bg-gradient-danger {
        background: linear-gradient(135deg, #f5365c 0%, #ec0c38 100%) !important;
    }

    .bg-gradient-info {
        background: linear-gradient(135deg, #11cdef 0%, #00a0ff 100%) !important;
    }

    .bg-gradient-success {
        background: linear-gradient(135deg, #2dce89 0%, #11a83f 100%) !important;
    }

    .bg-gradient-warning {
        background: linear-gradient(135deg, #fb6340 0%, #fbb034 100%) !important;
    }

    .face-box {
        position: absolute;
        border: 3px solid #2dce89;
        border-radius: 8px;
        background: transparent;
    }

    .face-label {
        position: absolute;
        background: #2dce89;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
        z-index: 10;
    }
</style>
{% endblock %}
