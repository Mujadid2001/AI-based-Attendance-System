{% extends 'base.html' %}
{% load static %}

{% block title %}Student Registration with Face - Attendance System{% endblock %}

{% block extra_css %}
<style>
    body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
    }
    .registration-container {
        padding-top: 60px;
        padding-bottom: 40px;
    }
    .step-indicator {
        display: flex;
        justify-content: space-between;
        margin-bottom: 40px;
        position: relative;
    }
    .step-indicator::before {
        content: '';
        position: absolute;
        top: 20px;
        left: 0;
        right: 0;
        height: 2px;
        background: #ddd;
        z-index: 1;
    }
    .step {
        flex: 1;
        text-align: center;
        position: relative;
        z-index: 2;
    }
    .step-circle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: white;
        border: 3px solid #ddd;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 10px;
        font-weight: bold;
        color: #667eea;
    }
    .step.active .step-circle {
        background: #667eea;
        color: white;
        border-color: #667eea;
    }
    .step.completed .step-circle {
        background: #22c55e;
        color: white;
        border-color: #22c55e;
    }
    .step-label {
        font-size: 0.9rem;
        color: #666;
    }
    .form-section {
        display: none;
    }
    .form-section.active {
        display: block;
        animation: fadeIn 0.3s;
    }
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    .card {
        border: none;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        border-radius: 15px;
    }
    .webcam-container {
        background: #000;
        border-radius: 10px;
        overflow: hidden;
        position: relative;
        height: 400px;
        margin: 20px 0;
    }
    .webcam-container video {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .status-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        padding: 8px 12px;
        background: rgba(0,0,0,0.7);
        color: white;
        border-radius: 20px;
        font-size: 0.85rem;
    }
    .btn-group {
        display: flex;
        gap: 10px;
        margin-top: 20px;
    }
    .capture-counter {
        text-align: center;
        font-size: 1.2rem;
        font-weight: bold;
        color: #667eea;
        margin: 20px 0;
    }
    .progress-bar-custom {
        height: 8px;
        background: #ddd;
        border-radius: 10px;
        overflow: hidden;
        margin: 20px 0;
    }
    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #667eea, #764ba2);
        width: 0%;
        transition: width 0.3s;
    }
    .error-message {
        color: #ef4444;
        padding: 10px;
        border-radius: 5px;
        background: #fee;
        margin: 10px 0;
    }
    .success-message {
        color: #22c55e;
        padding: 10px;
        border-radius: 5px;
        background: #efe;
        margin: 10px 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="registration-container">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <!-- Step Indicator -->
                <div class="step-indicator mb-5">
                    <div class="step active" id="step1-indicator">
                        <div class="step-circle">1</div>
                        <div class="step-label">Account Details</div>
                    </div>
                    <div class="step" id="step2-indicator">
                        <div class="step-circle">2</div>
                        <div class="step-label">Face Registration</div>
                    </div>
                    <div class="step" id="step3-indicator">
                        <div class="step-circle">3</div>
                        <div class="step-label">Confirmation</div>
                    </div>
                </div>

                <!-- Step 1: Account Details -->
                <div class="form-section active" id="step1">
                    <div class="card">
                        <div class="card-body p-5">
                            <h3 class="mb-4"><i class="fas fa-user-plus"></i> Create Your Account</h3>
                            <form id="accountForm">
                                <div class="mb-3">
                                    <label class="form-label">First Name</label>
                                    <input type="text" class="form-control form-control-lg" id="firstName" placeholder="John" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Last Name</label>
                                    <input type="text" class="form-control form-control-lg" id="lastName" placeholder="Doe" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Email</label>
                                    <input type="email" class="form-control form-control-lg" id="email" placeholder="student@university.edu" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Roll Number</label>
                                    <input type="text" class="form-control form-control-lg" id="rollNumber" placeholder="2024001" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Department</label>
                                    <input type="text" class="form-control form-control-lg" id="department" placeholder="Computer Science" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Semester</label>
                                    <select class="form-select form-select-lg" id="semester" required>
                                        <option value="">Select Semester</option>
                                        <option value="1">Semester 1</option>
                                        <option value="2">Semester 2</option>
                                        <option value="3">Semester 3</option>
                                        <option value="4">Semester 4</option>
                                        <option value="5">Semester 5</option>
                                        <option value="6">Semester 6</option>
                                        <option value="7">Semester 7</option>
                                        <option value="8">Semester 8</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Password</label>
                                    <input type="password" class="form-control form-control-lg" id="password" placeholder="••••••••" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Confirm Password</label>
                                    <input type="password" class="form-control form-control-lg" id="confirmPassword" placeholder="••••••••" required>
                                </div>
                                <div id="accountError"></div>
                                <button type="button" class="btn btn-primary btn-lg w-100 rounded-4" onclick="proceedToFaceRegistration()">
                                    <i class="fas fa-arrow-right"></i> Next: Face Registration
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Face Registration -->
                <div class="form-section" id="step2">
                    <div class="card">
                        <div class="card-body p-5">
                            <h3 class="mb-4"><i class="fas fa-camera"></i> Register Your Face</h3>
                            <p class="text-muted mb-4">
                                We need to capture your face for attendance recognition. Please position your face in front of the camera and click "Capture" multiple times (at least 5 times) from different angles.
                            </p>

                            <!-- Webcam -->
                            <div class="webcam-container">
                                <video id="registrationWebcam" autoplay playsinline></video>
                                <div class="status-badge" id="webcamStatus">
                                    <i class="fas fa-spinner fa-spin"></i> Initializing...
                                </div>
                            </div>

                            <!-- Capture Counter -->
                            <div class="capture-counter">
                                <i class="fas fa-check-circle text-success"></i> Captures: <span id="captureCount">0</span>/5
                            </div>

                            <!-- Progress Bar -->
                            <div class="progress-bar-custom">
                                <div class="progress-fill" id="progressFill"></div>
                            </div>

                            <!-- Messages -->
                            <div id="faceError"></div>
                            <div id="faceSuccess"></div>

                            <!-- Controls -->
                            <div class="btn-group">
                                <button type="button" class="btn btn-primary btn-lg flex-grow-1 rounded-4" onclick="startRegistrationWebcam()">
                                    <i class="fas fa-play"></i> Start Webcam
                                </button>
                                <button type="button" class="btn btn-success btn-lg flex-grow-1 rounded-4" style="display:none;" id="captureFaceBtn" onclick="captureFace()">
                                    <i class="fas fa-camera"></i> Capture Face
                                </button>
                                <button type="button" class="btn btn-danger btn-lg flex-grow-1 rounded-4" style="display:none;" id="stopWebcamBtn" onclick="stopRegistrationWebcam()">
                                    <i class="fas fa-stop"></i> Stop
                                </button>
                            </div>

                            <div class="btn-group mt-3">
                                <button type="button" class="btn btn-secondary btn-lg flex-grow-1 rounded-4" onclick="goBackToStep1()">
                                    <i class="fas fa-arrow-left"></i> Back
                                </button>
                                <button type="button" class="btn btn-success btn-lg flex-grow-1 rounded-4" id="proceedStep3Btn" style="display:none;" onclick="proceedToConfirmation()">
                                    <i class="fas fa-arrow-right"></i> Continue
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Confirmation -->
                <div class="form-section" id="step3">
                    <div class="card">
                        <div class="card-body p-5">
                            <h3 class="mb-4"><i class="fas fa-check-circle text-success"></i> Registration Complete!</h3>
                            <p class="text-muted mb-4">
                                Your account has been created successfully with your face registered for attendance recognition.
                            </p>

                            <div class="alert alert-info">
                                <h5 class="alert-heading">You can now:</h5>
                                <ul class="mb-0">
                                    <li>✅ Log in to your account</li>
                                    <li>✅ Mark attendance using your registered face</li>
                                    <li>✅ View your attendance records</li>
                                    <li>✅ Download attendance reports</li>
                                </ul>
                            </div>

                            <div class="mb-3 p-3 bg-light rounded">
                                <p class="mb-2"><strong>Your Login Credentials:</strong></p>
                                <p class="mb-1"><strong>Email:</strong> <span id="confirmEmail"></span></p>
                                <p class="mb-0"><strong>Password:</strong> (The password you created)</p>
                            </div>

                            <a href="/" class="btn btn-primary btn-lg w-100 rounded-4">
                                <i class="fas fa-sign-in-alt"></i> Go to Login
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Face detection library -->
<script async src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.min.js"></script>

<script>
    let capturedFaces = [];
    let stream = null;
    const MIN_FACES_REQUIRED = 5;
    const MAX_FACE_SIZE = 30; // MB
    
    // Step 1: Account Validation
    function proceedToFaceRegistration() {
        const firstName = document.getElementById('firstName').value;
        const lastName = document.getElementById('lastName').value;
        const email = document.getElementById('email').value;
        const rollNumber = document.getElementById('rollNumber').value;
        const department = document.getElementById('department').value;
        const semester = document.getElementById('semester').value;
        const password = document.getElementById('password').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        
        // Validation
        if (!firstName || !lastName || !email || !rollNumber || !department || !semester) {
            showError('accountError', 'Please fill in all fields');
            return;
        }
        
        if (password.length < 8) {
            showError('accountError', 'Password must be at least 8 characters');
            return;
        }
        
        if (password !== confirmPassword) {
            showError('accountError', 'Passwords do not match');
            return;
        }
        
        // Clear error
        document.getElementById('accountError').innerHTML = '';
        
        // Move to step 2
        goToStep(2);
        
        // Load face-api models
        loadFaceApiModels();
    }
    
    async function loadFaceApiModels() {
        try {
            const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/';
            await Promise.all([
                faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL),
            ]);
            console.log('Face API models loaded successfully');
        } catch (error) {
            console.error('Error loading face-api models:', error);
            showError('faceError', 'Failed to load face detection models');
        }
    }
    
    async function startRegistrationWebcam() {
        try {
            stream = await navigator.mediaDevices.getUserMedia({ 
                video: { 
                    width: { ideal: 640 },
                    height: { ideal: 480 },
                    facingMode: 'user'
                }
            });
            
            const video = document.getElementById('registrationWebcam');
            video.srcObject = stream;
            
            document.getElementById('webcamStatus').innerHTML = '<i class="fas fa-video text-success"></i> Ready';
            document.getElementById('captureFaceBtn').style.display = 'block';
            document.getElementById('stopWebcamBtn').style.display = 'block';
            document.querySelector('button:nth-of-type(1)').style.display = 'none';
            
            // Start face detection overlay
            detectFaces();
        } catch (error) {
            console.error('Webcam error:', error);
            showError('faceError', 'Unable to access webcam. Please check permissions.');
        }
    }
    
    function stopRegistrationWebcam() {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
        }
        document.getElementById('webcamStatus').innerHTML = '<i class="fas fa-video"></i> Stopped';
        document.getElementById('captureFaceBtn').style.display = 'none';
        document.getElementById('stopWebcamBtn').style.display = 'none';
        document.querySelector('button:nth-of-type(1)').style.display = 'block';
    }
    
    async function captureFace() {
        const video = document.getElementById('registrationWebcam');
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0);
        
        // Detect face in captured image
        const detections = await faceapi.detectAllFaces(canvas, new faceapi.TinyFaceDetector());
        
        if (detections.length === 0) {
            showError('faceError', '❌ No face detected. Please position your face clearly in front of camera.');
            return;
        }
        
        if (detections.length > 1) {
            showError('faceError', '⚠️ Multiple faces detected. Please ensure only your face is visible.');
            return;
        }
        
        // Save captured face
        capturedFaces.push(canvas.toDataURL('image/jpeg'));
        const count = capturedFaces.length;
        
        document.getElementById('captureCount').innerHTML = count;
        const progress = (count / MIN_FACES_REQUIRED) * 100;
        document.getElementById('progressFill').style.width = progress + '%';
        
        showSuccess('faceSuccess', `✅ Face captured! (${count}/${MIN_FACES_REQUIRED})`);
        
        if (count >= MIN_FACES_REQUIRED) {
            document.getElementById('faceSuccess').innerHTML += '<br>✨ You have enough face captures! You can proceed now.';
            document.getElementById('proceedStep3Btn').style.display = 'block';
            stopRegistrationWebcam();
        }
    }
    
    // Helper function to convert data URL to Blob
    function dataURLtoBlob(dataurl) {
        var arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1],
            bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);
        while(n--){
            u8arr[n] = bstr.charCodeAt(n);
        }
        return new Blob([u8arr], {type:mime});
    }

    async function proceedToConfirmation() {
        if (capturedFaces.length < 1) {
            showError('faceError', 'Please capture at least one face image.');
            return;
        }

        // Create FormData
        const formData = new FormData();
        formData.append('first_name', document.getElementById('firstName').value);
        formData.append('last_name', document.getElementById('lastName').value);
        formData.append('email', document.getElementById('email').value);
        formData.append('roll_number', document.getElementById('rollNumber').value);
        formData.append('department', document.getElementById('department').value);
        formData.append('semester', document.getElementById('semester').value);
        formData.append('password', document.getElementById('password').value);

        // Append face image - sending only the first one for registration
        const faceBlob = dataURLtoBlob(capturedFaces[0]);
        formData.append('face_image', faceBlob, 'face_image.jpg');

        // Display loading state
        const proceedBtn = document.getElementById('proceedStep3Btn');
        const originalBtnText = proceedBtn.innerHTML;
        proceedBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Registering...';
        proceedBtn.disabled = true;

        try {
            // Using the correct API endpoint
            const response = await fetch('/api/auth/authentication/register_student_with_face/', {
                method: 'POST',
                body: formData,
            });

            const result = await response.json();

            if (response.ok) {
                // Update confirmation page
                document.getElementById('confirmEmail').textContent = result.user.email;
                goToStep(3);
            } else {
                // Handle server-side errors
                let errorMessage = result.error || 'An unknown error occurred.';
                if (typeof result === 'object' && result !== null) {
                    errorMessage = Object.entries(result).map(([key, value]) => `<strong>${key}:</strong> ${Array.isArray(value) ? value.join(', ') : value}`).join('<br>');
                }
                showError('faceError', `Registration Failed:<br>${errorMessage}`);
            }
        } catch (error) {
            console.error('Registration request failed:', error);
            showError('faceError', 'Registration request failed. Please check your network connection.');
        } finally {
            // Restore button state
            proceedBtn.innerHTML = originalBtnText;
            proceedBtn.disabled = false;
        }
    }
    
    function goToStep(step) {
        // Hide all sections
        document.getElementById('step1').classList.remove('active');
        document.getElementById('step2').classList.remove('active');
        document.getElementById('step3').classList.remove('active');
        
        // Update indicators
        document.getElementById('step1-indicator').classList.remove('active', 'completed');
        document.getElementById('step2-indicator').classList.remove('active', 'completed');
        document.getElementById('step3-indicator').classList.remove('active', 'completed');
        
        // Show selected step
        if (step === 1) {
            document.getElementById('step1').classList.add('active');
            document.getElementById('step1-indicator').classList.add('active');
        } else if (step === 2) {
            document.getElementById('step1-indicator').classList.add('completed');
            document.getElementById('step2').classList.add('active');
            document.getElementById('step2-indicator').classList.add('active');
        } else if (step === 3) {
            document.getElementById('step1-indicator').classList.add('completed');
            document.getElementById('step2-indicator').classList.add('completed');
            document.getElementById('step3').classList.add('active');
            document.getElementById('step3-indicator').classList.add('active');
        }
    }
    
    function goBackToStep1() {
        capturedFaces = [];
        document.getElementById('captureCount').innerHTML = '0';
        document.getElementById('progressFill').style.width = '0%';
        document.getElementById('faceError').innerHTML = '';
        document.getElementById('faceSuccess').innerHTML = '';
        document.getElementById('proceedStep3Btn').style.display = 'none';
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
        }
        goToStep(1);
    }
    
    async function detectFaces() {
        const video = document.getElementById('registrationWebcam');
        if (!video || !video.srcObject) return;
        
        const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetector());
        
        if (detections.length > 0) {
            document.getElementById('webcamStatus').innerHTML = '<i class="fas fa-face-smile text-success"></i> Face Detected';
        } else {
            document.getElementById('webcamStatus').innerHTML = '<i class="fas fa-video"></i> No Face';
        }
        
        requestAnimationFrame(detectFaces);
    }
    
    function showError(elementId, message) {
        const el = document.getElementById(elementId);
        el.innerHTML = `<div class="error-message"><i class="fas fa-exclamation-circle"></i> ${message}</div>`;
    }
    
    function showSuccess(elementId, message) {
        const el = document.getElementById(elementId);
        el.innerHTML = `<div class="success-message"><i class="fas fa-check-circle"></i> ${message}</div>`;
    }
    
    // Initialize
    window.addEventListener('load', function() {
        goToStep(1);
    });
</script>

<style>
    @media (max-width: 768px) {
        .step-indicator {
            margin-bottom: 30px;
        }
        .step-circle {
            width: 35px;
            height: 35px;
        }
        .step-label {
            font-size: 0.8rem;
        }
        .btn-group {
            flex-direction: column;
        }
        .webcam-container {
            height: 300px;
        }
    }
</style>
{% endblock %}
