{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="card shadow-lg border-0">
                <div class="card-header bg-gradient-primary text-white p-4">
                    <h2 class="mb-0"><i class="fas fa-face-smile me-2"></i>Face Registration</h2>
                    <p class="text-light mb-0 mt-2">Register your face for attendance marking</p>
                </div>
                <div class="card-body p-5">
                    <!-- Progress indicator -->
                    <div class="progress mb-4" style="height: 5px;">
                        <div class="progress-bar bg-success" role="progressbar" style="width: 0%" id="uploadProgress"></div>
                    </div>

                    <!-- Webcam Section -->
                    <div class="row mb-5">
                        <div class="col-md-6">
                            <h5 class="mb-3"><i class="fas fa-camera text-primary"></i> Webcam Capture</h5>
                            <div class="webcam-container border rounded-3 bg-dark d-flex align-items-center justify-content-center" style="height: 300px; position: relative; overflow: hidden;">
                                <video id="webcam" width="100%" height="100%" style="object-fit: cover;"></video>
                                <canvas id="canvas" style="display: none;"></canvas>
                                <div id="webcamPlaceholder" class="text-center text-white" style="position: absolute;">
                                    <i class="fas fa-video fa-3x mb-3"></i>
                                    <p>Webcam initializing...</p>
                                </div>
                            </div>
                            <div class="mt-3">
                                <button id="startWebcamBtn" class="btn btn-primary me-2" onclick="startWebcam()">
                                    <i class="fas fa-play"></i> Start Webcam
                                </button>
                                <button id="stopWebcamBtn" class="btn btn-danger" onclick="stopWebcam()" style="display: none;">
                                    <i class="fas fa-stop"></i> Stop Webcam
                                </button>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <h5 class="mb-3"><i class="fas fa-image text-info"></i> Captured Images</h5>
                            <div id="capturedImagesContainer" class="border rounded-3 p-3" style="height: 300px; overflow-y: auto; background-color: #f8f9fa;">
                                <p class="text-muted text-center py-5">No images captured yet</p>
                            </div>
                            <div class="mt-3">
                                <button id="captureBtn" class="btn btn-success me-2" onclick="captureImage()" style="display: none;">
                                    <i class="fas fa-camera"></i> Capture
                                </button>
                                <button id="clearCapturesBtn" class="btn btn-warning" onclick="clearCaptures()">
                                    <i class="fas fa-trash"></i> Clear All
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Face Detection Info -->
                    <div class="alert alert-info" id="faceDetectionInfo" style="display: none;">
                        <i class="fas fa-info-circle"></i> Face detected! <span id="faceCount"></span>
                    </div>

                    <!-- Upload Section -->
                    <hr class="my-5">
                    <h5 class="mb-3"><i class="fas fa-cloud-upload-alt text-success"></i> Upload Options</h5>
                    
                    <div class="form-group mb-3">
                        <label for="fileInput" class="form-label">Or upload image file:</label>
                        <input type="file" class="form-control" id="fileInput" accept="image/*" multiple>
                        <small class="text-muted">Supported formats: JPG, PNG, GIF</small>
                    </div>

                    <!-- Registration Instructions -->
                    <div class="card bg-light border-0 mb-4">
                        <div class="card-body">
                            <h6 class="card-title"><i class="fas fa-lightbulb text-warning"></i> Tips for Best Results</h6>
                            <ul class="mb-0">
                                <li>Ensure good lighting (natural light preferred)</li>
                                <li>Face should be clearly visible and centered</li>
                                <li>Remove sunglasses and hats if possible</li>
                                <li>Capture at least 3-5 different angles</li>
                                <li>Look directly at the camera</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div class="mt-4 text-center">
                        <button id="submitBtn" class="btn btn-primary btn-lg" onclick="submitRegistration()" disabled>
                            <i class="fas fa-check"></i> Complete Registration
                        </button>
                        <a href="{% url 'student_dashboard' %}" class="btn btn-secondary btn-lg ms-2">
                            <i class="fas fa-times"></i> Cancel
                        </a>
                    </div>

                    <!-- Status Messages -->
                    <div id="statusMessages" class="mt-4"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Face detection library -->
<script async src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.min.js"></script>
<script src="{% static 'js/face-registration.js' %}"></script>

<style>
    .bg-gradient-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    }

    .webcam-container {
        position: relative;
        background: #000;
    }

    .webcam-container video {
        transform: scaleX(-1);
    }

    #capturedImagesContainer {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        gap: 10px;
        align-content: start;
    }

    .captured-image {
        position: relative;
        border-radius: 8px;
        overflow: hidden;
        border: 2px solid #667eea;
    }

    .captured-image img {
        width: 100%;
        height: 80px;
        object-fit: cover;
    }

    .captured-image .remove-btn {
        position: absolute;
        top: 0;
        right: 0;
        background: rgba(255, 0, 0, 0.8);
        color: white;
        border: none;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 12px;
    }
</style>
{% endblock %}
