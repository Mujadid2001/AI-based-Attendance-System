{% extends 'base.html' %}
{% load static %}

{% block title %}Attendance Dashboard{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col">
            <h1 class="h3 mb-0">
                <i class="fas fa-camera"></i> Real-Time Attendance
            </h1>
        </div>
    </div>

    <div class="row g-4">
        <!-- Webcam Feed -->
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <i class="fas fa-video"></i> Webcam Feed
                </div>
                <div class="card-body">
                    <div class="webcam-container">
                        <video id="attendanceWebcam" autoplay playsinline></video>
                        <div id="webcamOverlay"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Session Management -->
        <div class="col-lg-4">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <i class="fas fa-cogs"></i> Session Management
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="courseSelect" class="form-label">Course</label>
                        <select class="form-select" id="courseSelect">
                            <!-- Courses will be loaded here -->
                        </select>
                    </div>
                    <div class="d-grid gap-2">
                        <button id="startSessionBtn" class="btn btn-primary">
                            <i class="fas fa-play"></i> Start Session
                        </button>
                        <button id="stopSessionBtn" class="btn btn-danger" style="display: none;">
                            <i class="fas fa-stop"></i> Stop Session
                        </button>
                    </div>
                    <div id="sessionStatus" class="mt-3"></div>
                </div>
            </div>
        </div>

        <!-- Attendance Log -->
        <div class="col-lg-4">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <i class="fas fa-list-check"></i> Attendance Log
                </div>
                <div class="card-body" id="attendanceLog">
                    <p class="text-muted text-center">No students marked yet.</p>
                </div>
            </div>

            <!-- Manual Attendance -->
            <div class="card shadow-sm mt-4">
                <div class="card-header bg-primary text-white">
                    <i class="fas fa-edit"></i> Manual Attendance
                </div>
                <div class="card-body" id="manualAttendance">
                    <!-- Student list will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .webcam-container {
        position: relative;
    }
    #attendanceWebcam {
        width: 100%;
        border-radius: 8px;
    }
    #webcamOverlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
    }
</style>

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const video = document.getElementById('attendanceWebcam');
        const startSessionBtn = document.getElementById('startSessionBtn');
        const attendanceLog = document.getElementById('attendanceLog');
        let stream;
        let detectionInterval;

        // Load FaceAPI models
        async function loadModels() {
            const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/';
            await Promise.all([
                faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
            ]);
        }

        loadModels();

        async function detectAndRecognize() {
            const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions());

            if (detections.length > 0) {
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);

                const frame = canvas.toDataURL('image/jpeg');
                sendFrameForRecognition(frame);
            }
        }

        const socket = new WebSocket('ws://' + window.location.host + '/ws/attendance/');

        socket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            const result = data.result;

            if (result.success) {
                const student = result.student;
                const logEntry = document.createElement('div');
                logEntry.innerHTML = `<strong>${student.name}</strong> (${student.roll_number}) - Present`;
                attendanceLog.appendChild(logEntry);
            }
        };

        let activeSessionId = null;

        function sendFrameForRecognition(frame) {
            if (activeSessionId) {
                socket.send(JSON.stringify({
                    'image': frame,
                    'session_id': activeSessionId
                }));
            }
        }

        async function loadCourses() {
            const response = await fetch('/api/students/courses/');
            const courses = await response.json();
            const courseSelect = document.getElementById('courseSelect');
            courses.forEach(course => {
                const option = document.createElement('option');
                option.value = course.id;
                option.textContent = course.name;
                courseSelect.appendChild(option);
            });
        }

        document.getElementById('startSessionBtn').addEventListener('click', async () => {
            const courseId = document.getElementById('courseSelect').value;
            const response = await fetch('/api/attendance/sessions/create_session/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    course: courseId,
                    date: new Date().toISOString().slice(0, 10),
                    start_time: new Date().toLocaleTimeString('it-IT')
                })
            });
            if (response.ok) {
                const session = await response.json();
                activeSessionId = session.id;
                document.getElementById('sessionStatus').textContent = `Session started for ${session.course.name}`;
                document.getElementById('startSessionBtn').style.display = 'none';
                document.getElementById('stopSessionBtn').style.display = 'block';
                startWebcam();
            } else {
                alert('Failed to start session.');
            }
        });

        async function startWebcam() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                clearInterval(detectionInterval);
                stream = null;
            }

            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: {} });
                video.srcObject = stream;

                video.onloadedmetadata = () => {
                    detectionInterval = setInterval(detectAndRecognize, 1000); // Every second
                };
            } catch (error) {
                console.error('Error accessing webcam:', error);
                alert('Could not access webcam. Please grant permission and try again.');
            }
        }

        document.getElementById('stopSessionBtn').addEventListener('click', async () => {
            const response = await fetch(`/api/attendance/sessions/${activeSessionId}/close_session/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            });
            if (response.ok) {
                activeSessionId = null;
                document.getElementById('sessionStatus').textContent = 'Session stopped.';
                document.getElementById('startSessionBtn').style.display = 'block';
                document.getElementById('stopSessionBtn').style.display = 'none';
            } else {
                alert('Failed to stop session.');
            }
        });

        loadCourses();

        async function loadStudentList() {
            const response = await fetch('/api/students/profiles/');
            const students = await response.json();
            const manualAttendance = document.getElementById('manualAttendance');
            manualAttendance.innerHTML = '';

            students.forEach(student => {
                const studentDiv = document.createElement('div');
                studentDiv.innerHTML = `
                    <p>${student.user.first_name} ${student.user.last_name}</p>
                    <button class="btn btn-sm btn-success" onclick="markManualAttendance(${student.id}, 'present')">P</button>
                    <button class="btn btn-sm btn-danger" onclick="markManualAttendance(${student.id}, 'absent')">A</button>
                    <button class="btn btn-sm btn-warning" onclick="markManualAttendance(${student.id}, 'late')">L</button>
                `;
                manualAttendance.appendChild(studentDiv);
            });
        }

        async function markManualAttendance(studentId, status) {
            const activeSession = await fetch('/api/attendance/active_session/');
            if (!activeSession.ok) {
                alert('No active session. Please start a session first.');
                return;
            }
            const session = await activeSession.json();

            await fetch('/api/attendance/records/mark_attendance/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    session: session.id,
                    student: studentId,
                    status: status
                })
            });
        }

        loadStudentList();
    });
</script>
{% endblock %}
